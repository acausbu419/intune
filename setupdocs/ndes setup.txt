ndes setup

service account:
user: sa_ndes
pass: hoPv3jCSy90s7zqJHDpP

server group:
intune-ndes

server:
aad-ndes

add aad-ndes to intune-ndes group

add sa_ndes to local admin group
add sa_ndes to security gpo for logon as batch rights
add sa_ndes to 

#open console to ds-ca
#run the following
certutil -setreg Policy\EditFlags +EDITF_ATTRIBUTEENDDATE
net stop certsvc && net start certsvc

open certification authority console
right click certificate templates
click manage

###
duplicate web server template
###

general tab:
name: NDES Server
validity period: 10 years

compatibility tab:
CA: Windows Server 2003
CR: Windows XP/Server 2003

Request Handling tab:
Make sure 'Allow private key to be exported' is NOT checked.

Cryptography:
Minimum key size: 2048

Subject name:
Make sure 'Supply in the request' is checked.

Extensions:
Click application policies
click edit
Add 'client authentication'

Security:
Remove Enroll permission from Domain Admins and Enterprise Admins
Add intune-ndes group, granting read and enroll permissions.

#####

###
duplicate user template
###

General:
name 'NDES Intune'
validity period: 5 years

compatibility:
CA: Windows Server 2003
CR: Windows XP/Server 2003

Request Handling:
uncheck 'Allow private key to be exported'

Cryptography:
2048 key size

Extensions:
Make sure 'Client authentication, secure email, and encrypting file system' are listed in application policies
Edit 'Key Usage'
Uncheck 'signature is proof of origin'

Subject Name:
Check 'supply in the request'

Security:
Remove enroll permissions for domain admins/users & Enterprise Admins
Add the 'sa ndes' account with read and enroll permissions

###
duplicate Exchange Enrollment Agent (Offline Request)

General:
name NDES Exchange Enrollment Agent (Offline Request)

Security:
Remove enroll permissions for domain admins/users & Enterprise Admins
Add the 'sa ndes' account with read and enroll permissions

###
duplicate CEP Encryption

General:
name NDES CEP Encryption

Security:
Security:
Remove enroll permissions for domain admins/users & Enterprise Admins
Add the 'sa ndes' account with read and enroll permissions

###
Possibily duplicate IPSEC as well (not yet done)

#####

Go back to CA console
Right click cert templates, select new, cert template to issue
Issue:
NDES Intune
NDES Server
NDES CEP Encryption
NDES Exchange Enrollment Agent (Offline)

Done with CA server

#######

DNS:
Add cname record for ndes.arcare.net to point to aad-ndes.arcare.net

#####

NDES Server

Head over to the azure portal

Navigate to the application proxy section
click configure an app
download and install the application proxy connector to aad-ndes

name: Intune NDES
Internal URL: https://ndes.arcare.net
Internal URL: https://intunendes-arcare.msappproxy.net
External URL: https://intunendes-arcare.msappproxy.net
Pre Authentication: Passthrough

MMC > Cert console for local computer
Right click personal store, request new cert
Select NDES Server

General:
Name: NDES SSL Certificate

Subject:
Subject name: Type: Common name
Value: intunendes-arcare.msappproxy.net > click add
Alternative name: Type: DNS
value: intunendes-arcare.msappproxy.net > click add
value: aad-ndes.arcare.net > click add

###
MMC > Cert console for local computer
Right click personal store, request new cert
Select NDES Server

General:
Name: NDES Client Certificate

Subject:
Subject name: Type: Common name
Value: aad-ndes.arcare.net > click add
Alternative name: Type: DNS
value: intunendes-arcare.msappproxy.net > click add
value: aad-ndes.arcare.net > click add

#####

Install Server Role

download: https://github.com/MSEndpointMgr/Intune/blob/master/Certificates/Install-MSIntuneNDESServer.ps1

run as admin based on this example

.\Install-MSIntuneNDESServer.ps1 -CertificateAuthorityConfig "ds-ca.arcare.net\ARCARE-DS-CA-CA" -NDESTemplateName "NDESIntune" -NDESExternalFQDN "ndes-arcare.msappproxy.net" -RegistrationAuthorityName "YourName" -RegistrationAuthorityCompany "ARcare" -RegistrationAuthorityDepartment "IT" -RegistrationAuthorityCity "Augusta" -Verbose

If completed successfully, you can navigate to either:

https://intunendes-arcare.msappproxy.net/certsrv/mscep/mscep.dll
https://ndes.arcare.net/certsrv/mscep/mscep.dll

#####


